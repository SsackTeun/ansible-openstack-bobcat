---
# tasks file for pull-image-list-kolla/
- name: 서비스 리스트를 파일로 부터 읽음
  set_fact:
    services: "{{ lookup('file', 'openstack-kolla-services').splitlines() }}"

- name: 서비스 이름으로 레지스트리를 검색하여, 관련된 image 목록을 얻음
  containers.podman.podman_search:
    term: "{{ kolla_registry_prefix }}/{{ item }}"
  loop: "{{ services }}"
  register: podman_search_result

- name:
  debug:
    var: podman_search_result

- name: extract image names
  set_fact:
    search_list: "{{ podman_search_result.results | map(attribute='images') | flatten | map(attribute='Name') | list  }}"

- name: detail-images-list
  debug:
    var: search_list

- name: podman search contain tags
  containers.podman.podman_search:
    term: "{{ item }}"
    list_tags: True
  loop: "{{ search_list }}"
  register: include_tags


- name: 
  debug:
    var: include_tags 

- name: tag
  set_fact:
    specific_tag: >-
       {{
        include_tags.results |
        selectattr('images', 'defined') |
        map(attribute='images') |
        flatten |
        selectattr('Tags', 'defined') |
        selectattr('Tags', 'contains', tag_version ) |
        map(attribute='Name') |
        list
       }}
       
- name:
  debug:
    var: specific_tag
